#!/usr/bin/env python3

import argparse

import pandas

from canids.dataset_utils import pcap_utils
from canids.feature_extractors.basic_netflow_extractor import (
    BasicNetflowFeatureExtractor,
)
from canids.feature_extractors.payload_flows import NetflowPayloadAnalyser
from canids.transformers import OneHotEncoder
from canids.types import TrafficSequence


class PcapTrafficReader:
    def read(self, pcap_file):
        return TrafficSequence(
            name=pcap_file,
            is_consistent=False,
            ids=[],
            labels=pandas.Series(dtype=float),
            packet_reader=pcap_utils.read_pcap_pcapng(
                pcap_file, print_progress_after=200
            ),
        )


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("-p", "--pcap", help="Pcap file to read", required=True)
    parser.add_argument(
        "-o", "--output", help="CSV output file to write", required=True
    )
    parser.add_argument("--payloads", help="Analyse payloads", action="store_true")
    parser.add_argument(
        "--one-hot", help="Onehot-encode categorial features", action="store_true"
    )
    use_payloads = parser.parse_known_args()[0].payloads
    if not use_payloads:
        BasicNetflowFeatureExtractor.init_parser(parser)
    else:
        NetflowPayloadAnalyser.init_parser(parser)
    parsed = parser.parse_args()
    if not parsed.payloads:
        fe = BasicNetflowFeatureExtractor.init_by_parsed(parsed)
    else:
        fe = NetflowPayloadAnalyser.init_by_parsed(parsed)

    traffic = PcapTrafficReader().read(parsed.pcap)
    features = fe.extract_features(traffic)
    if parsed.one_hot:
        onehot_encoder = OneHotEncoder()
        features = onehot_encoder.fit_transform(features)
    df = features.as_pandas()
    df.to_csv(parsed.output)
    print(df)


if __name__ == "__main__":
    main()
